# 支付宝支付

## 简介

为解决网页、移动、平台商户及线下支付等场景支持用户使用支付宝付款需求，支付宝提供了如下支付能力供商家快速集成。

| 能力名称                                                     | 应用场景                                                     | 支持账户类型                   |
| ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------ |
| [当面付](https://opendocs.alipay.com/open/194/105072)        | 超市、餐馆线下交易场景，商家可生成订单二维码供用户扫码支付；<br />也可扫描用户二维码完成收款。 | 企业支付宝账户<br />个体工商户 |
| [App 支付](https://opendocs.alipay.com/open/204/105051)      | 支付宝为商家提供了客户端&服务端 SDK，帮助商家快速在自有 App 中集成支付宝支付功能。 | 企业支付宝账户<br />个体工商户 |
| [手机网站支付](https://opendocs.alipay.com/open/203/105288)  | 为商家移动端网页应用提供集成支付宝支付功能接口。             | 企业支付宝账户<br />个体工商户 |
| [电脑网站](https://opendocs.alipay.com/open/270/105898)[支付](##电脑网站支付) | 为商家 PC 端网页应用提供集成支付宝支付功能接口。             | 企业支付宝账户<br />个体工商户 |
| [刷脸付](https://opendocs.alipay.com/open/20180402104715814204/intro) | 商场、无人售货等线下自助支付场景，用户可通过刷脸操作使用支付宝付款。 | 企业支付宝账户<br />个体工商户 |
| [互联网平台直付通](https://opendocs.alipay.com/open/00faww)  | 集支付、结算、分账等功能为一体的直付通能力，<br />可帮助电商、互娱平台解决可能存在的合规问题。 | 企业支付宝账户                 |
| [支付宝预授权](https://opendocs.alipay.com/open/20180417160701241302/intro) | 租车、充电宝、酒店预订等需要用户在服务前做一笔预授权，<br />商家在服务完结时从预授权资金中扣除消费金额场景，可通过支付宝预授权能力实现。 | 企业支付宝账户                 |
| [新当面资金授权](https://opendocs.alipay.com/open/318/106376) | 酒店、景区等线下需要提前缴纳一定的押金，消费结束进行结算时，<br />再根据实际消费情况从押金中扣除消费金额的消费场景，可通过新当面资金授权能力实现。 | 企业支付宝账户                 |
| [周期扣款](https://opendocs.alipay.com/open/20190319114403226822/intro) | 会员收费、话费定时充值等周期定额扣款场景，<br />可通过周期扣款能力进行代扣订单创建及扣款，无需用户重复确认及输入支付密码。 | 企业支付宝账户                 |

## 电脑网站支付

### 简介

为方便网页应用商家接入支付宝支付功能，支付宝提供了电脑网站支付能力，商家可通过开放接口快速集成接入支付宝支付功能。电脑网站为即时到账升级而来的能力。

### 产品特色 

用户在 PC 端访问商家网站进行消费，通过电脑网站支付，可直接跳转到支付宝 PC 网站收银台完成付款。 交易资金直接打入商家支付宝账户，实时到账。 用户交易款项即时到账，提供退款、清结算、对账等配套服务。

### 使用说明

以下为电脑网站支付基本流程，页面仅供参考，可自定义。

1. 用户在商户网站选择需购买的商品及商品款式后，点击立即购买，如下图所示：

![img](https://gw.alipayobjects.com/os/skylark-tools/public/files/d7dcf47905aa0263effdc2d18caa9ac4.png%26originHeight%3D1736%26originWidth%3D3628%26size%3D1701781%26status%3Ddone%26width%3D3628)

1. 网页跳转到支付宝收银台页面，此时有两种付款方式供用户选择：

- - 用户可以使用支付宝 APP 扫一扫屏幕二维码，待手机提示付款后选择支付工具输入密码即可完成支付，如图1所示；
  - 如果不使用手机支付，也可以点击图 1 页面右侧的 **登录账户付款**，输入支付宝账号和支付密码登录 PC 收银台，如图 2 所示。![image](https://gw.alipayobjects.com/os/skylark-tools/public/files/314978918e1131b82c8df90083d0c7b8.png%26originHeight%3D1285%26originWidth%3D3628%26size%3D615829%26status%3Ddone%26width%3D3628)

1. 用户选择付款方式后，输入支付密码并点击 **确认付款**，付款成功则页面跳转到付款成功页。![image](https://gw.alipayobjects.com/os/skylark-tools/public/files/55f66fe602b084c0f78b18b013892d7a.png%26originHeight%3D1825%26originWidth%3D2457%26size%3D471875%26status%3Ddone%26width%3D2457)



## 接入准备

### 简介

本文档展示了如何从零开始，使用支付宝开放平台服务端 SDK 快速接入电脑网站支付功能。

**注意**：文档中的代码示例和 Demo 是用来阐述 API 基本使用方法的，仅针对大众场景，供 ISV（系统服务商） 参考，特殊情况还请 ISV 自行扩展，确保符合自身业务需求。

### 创建应用

登录[ 支付宝开放平台](https://open.alipay.com/)，创建应用并提交审核，审核通过后会生成应用唯一标识 APPID，并且可以申请开通开放产品使用权限。通过 APPID 应用才能调用开放产品的接口能力。详情请参考[ 创建应用](https://opendocs.alipay.com/open/200/105310)。

### 配置应用

#### 添加功能

应用创建完成后，系统会自动跳转到应用详情页面。您可以在 **能力列表** 中点击 **添加能力** 来添加 **电脑网站支付** 功能。详情请参见 [添加应用功能](https://opendocs.alipay.com/open/200/105310#添加应用功能)。

![image](http://mdn.alipayobjects.com/afts/img/A*Inc6Q7lmk6cAAAAAAAAAAAAAAa8wAA/original?bz=openpt_doc&t=5pIwjd1RQAAeX4rL-3rkWgAAAABkMK8AAAAA)

#### 开发设置

进入开发设置中完成接口加签方式、IP白名单、应用网关、接口内容加密方式开发信息设置。详情请参见 [配置应用环境](https://opendocs.alipay.com/open/200/105310#配置应用环境)。

![image](https://yuque.antfin.com/images/lark/0/2021/png/236382/1612252295110-b2b5f336-9ff1-455c-9480-a89fb08deab0.png)

- **接口加签方式：必填。**用于保障商户应用和支付宝交互的安全性，配置详情参见 [接口加签方式配置说明](https://opendocs.alipay.com/mini/introduce/01p6u8)。
- **IP白名单：选填。**用于保障用户资金安全，说明详情参见 [IP 白名单接入指南](https://opendocs.alipay.com/open/01qlnn)。
- **应用网关：选填。**用于接收支付宝异步通知消息，说明详情参见 [应用网关](https://opendocs.alipay.com/open/200/105310#界面说明如下)。
- **接口内容加密方式：选填**。用于加/解密 OpenAPI bizContent 报文内容及加/解密部分用户隐私信息，说明详情参见 [接口内容加密方式](https://opendocs.alipay.com/open/common/104567)。
- **授权回调地址：选填。**[第三方应用授权](https://opendocs.alipay.com/isv/10467/xldcyq) 或 [用户信息授权](https://opendocs.alipay.com/open/284/web#关于 redirect_uri 的说明) 后回调地址。授权链接中配置的 redirect_uri 的值必须与此值保持一致 (如：https://www.alipay.com) ，用户成功授权后将在该 url 后携带授权码等信息并跳转至该页。当填入该地址时，系统会自动进行安全检测，详情请参考 [安全检测](https://opendocs.alipay.com/open/316/106274)。

#### 上线应用

商户在添加功能和配置密钥后，即可将应用提交审核，预计会有一个工作日的审核时间，请耐心等待，详细步骤可参考 [上线应用](https://opendocs.alipay.com/open/200/golive/)。

应用上线后，还需要完成应用签约才能在线上环境（生产环境）使用功能。

#### 签约

请在应用详情页面的功能列表右侧点击 **签约**，填写并提交相关信息。详情请参见 [签约功能](https://opendocs.alipay.com/open/200/105314/)。

![image](http://mdn.alipayobjects.com/afts/img/A*KrrISKow0N4AAAAAAAAAAAAAAa8wAA/original?bz=openpt_doc&t=o7dIS9FLxkH0X9avg9bX7QAAAABkMK8AAAAA)

完成签约后，需要一个工作日左右的时间审核（审批结果会以短信和邮件形式告知），待审核完毕后，签约功能的状态将切换为 **已生效**，该应用即可使用功能。

### 集成并配置 SDK

服务端 SDK 需要商户集成在自己的服务端系统中，用于后续的服务端接口（OpenAPI）调用。

#### 第一步：下载服务端 SDK

为了帮助开发者调用开放接口，我们提供了 [开放平台服务端 SDK](https://opendocs.alipay.com/open/54/00y8k9)，包含 JAVA、PHP、NodeJS、Python 和 .NET 五种语言，封装了签名 & 验签、HTTP 接口请求等基础功能。

请先下载对应语言最新版本的 SDK 并引入您的开发工程。

**注意：**若您使用 **公钥证书** 进行加签，需额外引入如下 jar 包：

- [bcprov-jdk15on](https://mvnrepository.com/artifact/org.bouncycastle/bcprov-jdk15on)
- [commons-logging](https://mvnrepository.com/artifact/commons-logging/commons-logging)
- [fastjson](https://mvnrepository.com/artifact/com.alibaba/fastjson)

#### 第二步：接口调用配置

调用具体的 API 前需要进行 alipayClient 对象初始化。alipayClient 对象只需要初始化一次，后续调用不同的 API 都可以使用同一个 alipayClient 对象。

##### 普通公钥模式加签

接口加签方式为普通 **公钥** 模式加签时 alipayClient 对象初始化的 JAVA 语言示例代码如下：

```
AlipayClient alipayClient = new DefaultAlipayClient(URL,APP_ID,APP_PRIVATE_KEY,FORMAT,CHARSET,ALIPAY_PUBLIC_KEY,SIGN_TYPE);
```

##### 关键参数说明

| **配置参数**      | **示例值解释**                                               | **获取方式/示例值**                                          |
| ----------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| URL               | 支付宝网关（固定）。                                         | `https://openapi.alipay.com/gateway.do`                      |
| APPID             | APPID 即创建应用后生成。                                     | 获取见 [查看 APPID](https://opendocs.alipay.com/mini/introduce/create#查看 APPID)。 |
| APP_PRIVATE_KEY   | 开发者私钥，由开发者自己生成。                               | 获取见 [配置接口加签方式](https://opendocs.alipay.com/mini/introduce/01p6u8)。 |
| FORMAT            | 参数返回格式，只支持 JSON 格式。                             | json                                                         |
| CHARSET           | 编码集，支持 GBK/UTF-8。                                     | 开发者根据实际工程编码配置。                                 |
| ALIPAY_PUBLIC_KEY | 支付宝公钥，由支付宝生成。                                   | 获取详见 [配置接口加签方式](https://opendocs.alipay.com/mini/introduce/01p6u8)。 |
| SIGN_TYPE         | 商户生成签名字符串所使用的签名算法类型，目前支持 RSA2 和 RSA，推荐使用 RSA2。 | RSA2                                                         |

##### 公钥证书模式加签

接口加签方式为普通 **公钥证书** 模式加签时 alipayClient 对象初始化的 JAVA 语言示例代码如下：

```
CertAlipayRequest certAlipayRequest = new CertAlipayRequest ();
    certAlipayRequest.setServerUrl(URL);
    certAlipayRequest.setAppId(APPID);
    certAlipayRequest.setPrivateKey(APP_PRIVATE_KEY);
    certAlipayRequest.setFormat("JSON");
    certAlipayRequest.setCharset(CHARSET);
    certAlipayRequest.setSignType(SIGN_TYPE);
    certAlipayRequest.setCertPath(app_cert_pathAPP_CERT_PATH);
    certAlipayRequest.setAlipayPublicCertPath(alipay_cert_path);
    certAlipayRequest.setRootCertPath(alipay_root_cert_path );
    DefaultAlipayClient alipayClient = new DefaultAlipayClient(certAlipayRequest);
// 提交数据至支付宝时请使用 alipayClient.certificateExecute(request);
```

##### 关键参数说明

| **配置参数**          | **示例值解释**                                               | **获取方式/示例值**                                          |
| --------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| URL                   | 支付宝网关（固定）。                                         | `https://openapi.alipay.com/gateway.do`                      |
| APPID                 | APPID 即创建应用后生成。                                     | 获取见 [查看 APPID](https://opendocs.alipay.com/mini/introduce/create#查看 APPID)。 |
| APP_PRIVATE_KEY       | 开发者私钥，由开发者自己生成。                               | 获取见 [配置接口加签方式](https://opendocs.alipay.com/mini/introduce/01p6u8)。 |
| FORMAT                | 参数返回格式，只支持 JSON（固定）。                          | json                                                         |
| CHARSET               | 编码集，支持 GBK/UTF-8。                                     | 开发者根据实际工程编码配置。                                 |
| SIGN_TYPE             | 商户生成签名字符串所使用的签名算法类型，目前支持 RSA2 和 RSA，推荐使用 RSA2。 | RSA2                                                         |
| app_cert_path         | 应用公钥证书文件本地路径。                                   | 获取见 [配置接口加签方式](https://opendocs.alipay.com/mini/introduce/01p6u8)。 |
| alipay_cert_path      | 支付宝公钥证书文件本地路径。                                 | 获取见 [配置接口加签方式](https://opendocs.alipay.com/mini/introduce/01p6u8)。 |
| alipay_root_cert_path | 支付宝根证书文件本地路径。                                   | 获取见 [配置接口加签方式](https://opendocs.alipay.com/mini/introduce/01p6u8)。 |

## 开始

### 依赖

```xml
<!--阿里支付-->
<dependency>
    <groupId>com.alipay.sdk</groupId>
    <artifactId>alipay-sdk-java</artifactId>
    <version>4.23.0.ALL</version>
</dependency>
```

### 配置文件

```yaml
# 支付宝
alipay:
  # 应用ID
  app_id: 2021000119689508
  # 应用私钥
  application_alipay_private_key: 
  # 应用公钥
  application_alipay_public_key: 
  # 支付宝公钥
  alipay_public_key: 
  # 支付宝网关地址
  gateway_url: https://openapi.alipaydev.com/gateway.do
  # 同步回调
  return_url: http://ip或者域名/alipay/returnUrl
  # 异步回调
  notify_url: http://ip或者域名/alipay/notifyUrl
  # 返回格式
  format: json
  # 字符集
  charset: utf-8
  # 签名方式
  sign_type: RSA2
  # 保存支付日志的地址
  log_path: E:/tmp/
```

### 读取

```java
/**
 * 支付宝属性
 *
 * @author kk
 * @date 2022/05/10 08:56:39
 */
@Data
@Configuration
@ConfigurationProperties(prefix = "alipay")
public class AlipayProperties {
    /**
     * 应用程序id
     */
    private String appId;
    /**
     * 应用私钥
     */
    private String applicationAlipayPrivateKey;
    /**
     * 应用公钥
     */
    private String applicationAlipayPublicKey;
    /**
     * 支付宝公钥
     */
    private String alipayPublicKey;
    /**
     * 网关地址
     */
    private String gatewayUrl;
    /**
     * 同步回调
     */
    private String returnUrl;
    /**
     * 异步回调
     */
    private String notifyUrl;
    /**
     * 格式
     */
    private String format;
    /**
     * 字符集
     */
    private String charset;
    /**
     * 签名方式
     */
    private String signType;
    /**
     * 日志路径
     */
    private String logPath;
}
```

### 接口开始

```java
/**
 * 支付控制器
 *
 * @author user
 * @date 2022/05/09 13:43:45
 */
@RestController
@Slf4j
@RequestMapping("/alipay/")
public class PayController {

    @Resource
    private AlipayProperties properties;

    @PostMapping("placeOrder")
    public CommonResp placeOrder(@RequestBody @Valid PayOrderDto dto) throws AlipayApiException {
        String code = dto.getCode();
        if (StringUtils.isBlank(code)) {
            log.info("code不能为空！");
            return CommonResp.error(RespCode.BAD_REQUEST, ErrorBody.build(new Throwable("code不能为空！")));
        }
        PayService payService = PayTypeServiceMap.SERVICE_HAND_MAP.get(PayTypeEnum.queryPayTypeEnumByCode(code));
        if (payService != null) {
            return CommonResp.ok(payService.placeOrder(dto));
        }
        return CommonResp.ok();
    }

    @GetMapping("queryOrder")
    public CommonResp queryOrder(@RequestParam("code") String code, @RequestParam("outTradeNo") String outTradeNo) throws AlipayApiException {
        if (StringUtils.isBlank(code)) {
            log.info("code不能为空！");
            return CommonResp.error(RespCode.BAD_REQUEST, ErrorBody.build(new Throwable("code不能为空！")));
        }
        PayService payService = PayTypeServiceMap.SERVICE_HAND_MAP.get(PayTypeEnum.queryPayTypeEnumByCode(code));
        if (payService != null) {
            return CommonResp.ok(payService.queryOrder(outTradeNo));
        }
        return CommonResp.ok();
    }

    @PostMapping("refund")
    public CommonResp refund(@RequestBody @Valid PayRefundOrderDto dto) throws AlipayApiException {
        String code = dto.getCode();
        if (StringUtils.isBlank(code)) {
            log.info("code不能为空！");
            return CommonResp.error(RespCode.BAD_REQUEST, ErrorBody.build(new Throwable("code不能为空！")));
        }
        PayService payService = PayTypeServiceMap.SERVICE_HAND_MAP.get(PayTypeEnum.queryPayTypeEnumByCode(code));
        if (payService != null) {
            return CommonResp.ok(payService.refund(dto));
        }
        return CommonResp.ok();
    }

    @GetMapping("queryRefundOrder")
    public CommonResp queryRefundOrder(@RequestParam("code") String code, @RequestParam("outTradeNo") String outTradeNo) throws AlipayApiException {
        if (StringUtils.isBlank(code)) {
            log.info("code不能为空！");
            return CommonResp.error(RespCode.BAD_REQUEST, ErrorBody.build(new Throwable("code不能为空！")));
        }
        PayService payService = PayTypeServiceMap.SERVICE_HAND_MAP.get(PayTypeEnum.queryPayTypeEnumByCode(code));
        if (payService != null) {
            return CommonResp.ok(payService.queryRefundOrder(outTradeNo));
        }
        return CommonResp.ok();
    }

    @GetMapping("closeOrder")
    public CommonResp closeOrder(@RequestParam("code") String code, @RequestParam("outTradeNo") String outTradeNo) throws AlipayApiException {
        if (StringUtils.isBlank(code)) {
            log.info("code不能为空！");
            return CommonResp.error(RespCode.BAD_REQUEST, ErrorBody.build(new Throwable("code不能为空！")));
        }
        PayService payService = PayTypeServiceMap.SERVICE_HAND_MAP.get(PayTypeEnum.queryPayTypeEnumByCode(code));
        if (payService != null) {
            return CommonResp.ok(payService.closeOrder(outTradeNo));
        }
        return CommonResp.ok();
    }

    @PostMapping("appPay")
    public CommonResp appPay(@RequestBody @Valid PayOrderDto dto) throws AlipayApiException {
        String code = dto.getCode();
        if (StringUtils.isBlank(code)) {
            log.info("code不能为空！");
            return CommonResp.error(RespCode.BAD_REQUEST, ErrorBody.build(new Throwable("code不能为空！")));
        }
        PayService payService = PayTypeServiceMap.SERVICE_HAND_MAP.get(PayTypeEnum.queryPayTypeEnumByCode(code));
        if (payService != null) {
            return CommonResp.ok(payService.appPay(dto));
        }
        return CommonResp.ok();
    }

    @PostMapping("wapPay")
    public CommonResp wapPay(@RequestBody @Valid PayOrderDto dto) throws AlipayApiException {
        String code = dto.getCode();
        if (StringUtils.isBlank(code)) {
            log.info("code不能为空！");
            return CommonResp.error(RespCode.BAD_REQUEST, ErrorBody.build(new Throwable("code不能为空！")));
        }
        PayService payService = PayTypeServiceMap.SERVICE_HAND_MAP.get(PayTypeEnum.queryPayTypeEnumByCode(code));
        if (payService != null) {
            return CommonResp.ok(payService.wapPay(dto));
        }
        return CommonResp.ok();
    }

    @GetMapping("returnUrl")
    public void returnUrl() {
        log.info("同步回调");
    }
    
    @PostMapping("notifyUrl")
    public void notifyUrl(HttpServletRequest request) throws AlipayApiException {
        log.info("异步回调开始~~~~~");
        Map<String, String> params = PayUtils.convertRequestParamsToMap(request);
        String paramsJson = JSON.toJSONString(params);
        log.info("⽀付宝回调，{}", paramsJson);
        // 调⽤SDK验证签名
        boolean signVerified = AlipaySignature.rsaCheckV1(params, properties.getAlipayPublicKey(), properties.getCharset(), properties.getSignType());
        if (signVerified) {
            log.info("⽀付宝SDK验证签名成功");
            String outTradeNo = params.get("out_trade_no");
            // 1、商户需要验证该通知数据中的out_trade_no是否为商户系统中创建的订单号，
            if (StringUtils.isBlank(outTradeNo)) {
                throw new AlipayApiException("out_trade_no错误");
            }
            log.info("我真的查库，你相信我~");
            // 2、判断total_amount是否确实为该订单的实际⾦额（即商户订单创建时的⾦额），
            String amount = params.get("total_amount");
            if (StringUtils.isBlank(amount)) {
                throw new AlipayApiException("error total_amount");
            }
            log.info("我就是数据库里的金额啊~");
            // 3、验证app_id是否为该商户本⾝。
            if (!StringUtils.equalsIgnoreCase(params.get("app_id"), properties.getAppId())) {
                throw new AlipayApiException("app_id不⼀致");
            }
            log.info("是的，我就是配置中的appId");
        }
    }
}

/**
 * 支付服务接口
 *
 * @author kk
 * @date 2022/05/09 16:20:34
 */
public interface PayService {

    /**
     * 下单
     *
     * @param dto dto
     * @return {@link String}
     * @throws AlipayApiException 支付宝api例外
     */
    String placeOrder(PayOrderDto dto) throws AlipayApiException;

    /**
     * 退款
     *
     * @param dto dto
     * @return {@link String}
     * @throws AlipayApiException 支付宝api例外
     */
    String refund(PayRefundOrderDto dto) throws AlipayApiException;

    /**
     * 查询订单
     *
     * @param outTradeNo 订单号
     * @return {@link String}
     * @throws AlipayApiException 支付宝api例外
     */
    String queryOrder(String outTradeNo) throws AlipayApiException;

    /**
     * 查询退款订单
     *
     * @param outTradeNo 贸易没有
     * @return {@link String}
     * @throws AlipayApiException 支付宝api例外
     */
    String queryRefundOrder(String outTradeNo) throws AlipayApiException;

    /**
     * 关闭订单
     *
     * @param outTradeNo 贸易没有
     * @return {@link String}
     * @throws AlipayApiException 支付宝api例外
     */
    String closeOrder(String outTradeNo) throws AlipayApiException;

    /**
     * APP支付
     *
     * @param dto dto
     * @return {@link String}
     * @throws AlipayApiException 支付宝api例外
     */
    String appPay(PayOrderDto dto) throws AlipayApiException;

    /**
     * wap支付
     *
     * @param dto dto
     * @return {@link Object}
     * @throws AlipayApiException 支付宝api例外
     */
    Object wapPay(PayOrderDto dto) throws AlipayApiException;
}

/**
 * 支付宝服务impl
 *
 * @author kk
 * @date 2022/05/09 16:21:43
 */
@Slf4j
@Service
@PayType(value = PayTypeEnum.ALIPAY)
public class AlipayServiceImpl implements PayService {
    @Resource
    private AlipayProperties properties;
}
```

#### 统一收单下单并支付页面接口

```java
@Override
public String placeOrder(PayOrderDto dto) throws AlipayApiException {
    // 获得初始化的AlipayClient
    AlipayClient alipayClient = new DefaultAlipayClient(properties.getGatewayUrl(), properties.getAppId(), properties.getApplicationAlipayPrivateKey(), properties.getFormat(), properties.getCharset(), properties.getAlipayPublicKey(), properties.getSignType());
    // 设置请求参数
    AlipayTradePagePayRequest request = new AlipayTradePagePayRequest();
    request.setReturnUrl(properties.getReturnUrl());
    request.setNotifyUrl(properties.getNotifyUrl());
    AlipayTradePagePayModel model = new AlipayTradePagePayModel();
    model.setOutTradeNo(dto.getOutTradeNo());
    model.setTotalAmount(dto.getTotalAmount());
    model.setSubject(dto.getSubject());
    model.setProductCode("FAST_INSTANT_TRADE_PAY");
    // 花呗
    if (StringUtils.isNotBlank(dto.getHbFqNum()) && StringUtils.isNotBlank(dto.getHbFqSellerPercent())) {
        ExtendParams extendParams = new ExtendParams();
        extendParams.setHbFqNum(dto.getHbFqNum());
        extendParams.setHbFqSellerPercent(dto.getHbFqSellerPercent());
        model.setExtendParams(extendParams);
    }
    request.setBizModel(model);
    // 请求
    AlipayTradePagePayResponse response = alipayClient.pageExecute(request, "GET");
    if (response.isSuccess()) {
        log.info("调用成功~");
    } else {
        log.info("调用失败~");
    }
    String result = response.getBody();
    // 以下写自己的订单代码
    log.info("以下写自己的订单代码 ~");
    // 输出
    log.info(result);
    return result;
}
```

##### 请求参数

| 参数              | 类型          | 是否必填 | 最大长度 | 描述                                                         | 示例值                 |
| ----------------- | ------------- | -------- | -------- | ------------------------------------------------------------ | ---------------------- |
| out_trade_no      | String        | 必选     | 64       | 商户订单号。 由商家自定义，64个字符以内，仅支持字母、数字、下划线且需保证在商户端不重复。 | 20150320010101001      |
| total_amount      | Price         | 必选     | 11       | 订单总金额，单位为元，精确到小数点后两位，取值范围为 [0.01,100000000]。金额不能为0。 | 88.88                  |
| subject           | String        | 必选     | 256      | 订单标题。 注意：不可使用特殊字符，如 /，=，& 等。           | Iphone6 16G            |
| product_code      | String        | 必选     | 64       | 销售产品码，与支付宝签约的产品码名称。注：目前电脑支付场景下仅支持FAST_INSTANT_TRADE_PAY | FAST_INSTANT_TRADE_PAY |
| qr_pay_mode       | String        | 可选     | 2        | PC扫码支付的方式。 支持前置模式和跳转模式。 前置模式是将二维码前置到商户的订单确认页的模式。需要商户在自己的页面中以 iframe 方式请求支付宝页面。具体支持的枚举值有以下几种： 0：订单码-简约前置模式，对应 iframe 宽度不能小于600px，高度不能小于300px； 1：订单码-前置模式，对应iframe 宽度不能小于 300px，高度不能小于600px； 3：订单码-迷你前置模式，对应 iframe 宽度不能小于 75px，高度不能小于75px； 4：订单码-可定义宽度的嵌入式二维码，商户可根据需要设定二维码的大小。  跳转模式下，用户的扫码界面是由支付宝生成的，不在商户的域名下。支持传入的枚举值有： 2：订单码-跳转模式 | 1                      |
| qrcode_width      | Number        | 可选     | 4        | 商户自定义二维码宽度。 注：qr_pay_mode=4时该参数有效         | 100                    |
| goods_detail      | GoodsDetail[] | 可选     |          | 订单包含的商品列表信息，json格式。                           |                        |
| time_expire       | String        | 可选     | 32       | 订单绝对超时时间。 格式为yyyy-MM-dd HH:mm:ss。 注：time_expire和timeout_express两者只需传入一个或者都不传，两者均传入时，优先使用time_expire。 | 2016-12-31 10:05:01    |
| sub_merchant      | SubMerchant   | 可选     |          | 二级商户信息。 直付通模式和机构间连模式下必传，其它场景下不需要传入。 |                        |
| extend_params     | ExtendParams  | 可选     |          | 业务扩展参数                                                 |                        |
| business_params   | String        | 可选     | 512      | 商户传入业务信息，具体值要和支付宝约定，应用于安全，营销等参数直传场景，格式为json格式 | {"data":"123"}         |
| promo_params      | String        | 可选     | 512      | 优惠参数。为 JSON 格式。注：仅与支付宝协商后可用             | {"storeIdType":"1"}    |
| integration_type  | String        | 可选     | 16       | 请求后页面的集成方式。 枚举值： ALIAPP：支付宝钱包内 PCWEB：PC端访问 默认值为PCWEB。 | PCWEB                  |
| request_from_url  | String        | 可选     | 256      | 请求来源地址。如果使用ALIAPP的集成方式，用户中途取消支付会返回该地址。 | https://               |
| store_id          | String        | 可选     | 32       | 商户门店编号。 指商户创建门店时输入的门店编号。              | NJ_001                 |
| merchant_order_no | String        | 可选     | 32       | 商户原始订单号，最大长度限制 32 位                           | 20161008001            |
| invoice_info      | InvoiceInfo   | 可选     |          | 开票信息                                                     |                        |

##### 响应参数

| 参数              | 类型   | 是否必填 | 最大长度 | 描述                                                         | 示例值                       |
| ----------------- | ------ | -------- | -------- | ------------------------------------------------------------ | ---------------------------- |
| trade_no          | String | 必选     | 64       | 支付宝交易号                                                 | 2013112011001004330000121536 |
| out_trade_no      | String | 必选     | 64       | 商户订单号                                                   | 6823789339978248             |
| seller_id         | String | 必选     | 28       | 收款支付宝账号对应的支付宝唯一用户号。 以2088开头的纯16位数字 | 2088111111116894             |
| total_amount      | Price  | 必选     | 11       | 交易金额                                                     | 128.00                       |
| merchant_order_no | String | 必选     | 32       | 商户原始订单号，最大长度限制32位                             | 20161008001                  |

##### 支付宝接口返回的是 ：

```xml
// 响应为表单格式，可嵌入页面，具体以返回的结果为准
<form name="submit_form" method="post" action="https://openapi.alipay.com/gateway.do?charset=UTF-8&method=alipay.trade.page.pay&sign=k0w1DePFqNMQWyGBwOaEsZEJuaIEQufjoPLtwYBYgiX%2FRSkBFY38VuhrNumXpoPY9KgLKtm4nwWz4DEQpGXOOLaqRZg4nDOGOyCmwHmVSV5qWKDgWMiW%2BLC2f9Buil%2BEUdE8CFnWhM8uWBZLGUiCrAJA14hTjVt4BiEyiPrtrMZu0o6%2FXsBu%2Fi6y4xPR%2BvJ3KWU8gQe82dIQbowLYVBuebUMc79Iavr7XlhQEFf%2F7WQcWgdmo2pnF4tu0CieUS7Jb0FfCwV%2F8UyrqFXzmCzCdI2P5FlMIMJ4zQp%2BTBYsoTVK6tg12stpJQGa2u3%2BzZy1r0KNzxcGLHL%2BwWRTx%2FCU%2Fg%3D%3D&notify_url=http%3A%2F%2F114.55.81.185%2Fopendevtools%2Fnotify%2Fdo%2Fbf70dcb4-13c9-4458-a547-3a5a1e8ead04&version=1.0&app_id=2014100900013222&sign_type=RSA&timestamp=2021-02-02+14%3A11%3A40&alipay_sdk=alipay-sdk-java-dynamicVersionNo&format=json">
<input type="submit" value="提交" style="display:none" >
</form>
<script>document.forms[0].submit();</script>
```

##### 我返回的栗子：

```json
{
    "code": "200",
    "message": "请求成功",
    "body": "https://openapi.alipay.com/gateway.do?charset=UTF-8&method=alipay.trade.page.pay&sign=k0w1DePFqNMQWyGBwOaEsZEJuaIEQufjoPLtwYBYgiX%2FRSkBFY38VuhrNumXpoPY9KgLKtm4nwWz4DEQpGXOOLaqRZg4nDOGOyCmwHmVSV5qWKDgWMiW%2BLC2f9Buil%2BEUdE8CFnWhM8uWBZLGUiCrAJA14hTjVt4BiEyiPrtrMZu0o6%2FXsBu%2Fi6y4xPR%2BvJ3KWU8gQe82dIQbowLYVBuebUMc79Iavr7XlhQEFf%2F7WQcWgdmo2pnF4tu0CieUS7Jb0FfCwV%2F8UyrqFXzmCzCdI2P5FlMIMJ4zQp%2BTBYsoTVK6tg12stpJQGa2u3%2BzZy1r0KNzxcGLHL%2BwWRTx%2FCU%2Fg%3D%3D&notify_url=http%3A%2F%2F114.55.81.185%2Fopendevtools%2Fnotify%2Fdo%2Fbf70dcb4-13c9-4458-a547-3a5a1e8ead04&version=1.0&app_id=2014100900013222&sign_type=RSA&timestamp=2021-02-02+14%3A11%3A40&alipay_sdk=alipay-sdk-java-dynamicVersionNo&format=json",
    "ok": true
}
```

#### 统一收单线下交易查询

```java
@Override
public String queryOrder(String outTradeNo) throws AlipayApiException {
    AlipayClient alipayClient = new DefaultAlipayClient(properties.getGatewayUrl(), properties.getAppId(), properties.getApplicationAlipayPrivateKey(), properties.getFormat(), properties.getCharset(), properties.getAlipayPublicKey(), properties.getSignType());
    AlipayTradeQueryRequest request = new AlipayTradeQueryRequest();
    JSONObject bizContent = new JSONObject();
    bizContent.put("out_trade_no", outTradeNo);
    request.setBizContent(bizContent.toString());
    AlipayTradeQueryResponse response = alipayClient.execute(request);
    if (response.isSuccess()) {
        log.info("调用成功~");
    } else {
        log.info("调用失败~");
    }
    String result = response.getBody();
    log.info("查询一下~");
    log.info(result);
    return result;
}
```

##### 请求参数

| 参数          | 类型     | 是否必填 | 最大长度 | 描述                                                         | 示例值                        |
| ------------- | -------- | -------- | -------- | ------------------------------------------------------------ | ----------------------------- |
| out_trade_no  | String   | 特殊可选 | 64       | 订单支付时传入的商户订单号,和支付宝交易号不能同时为空。 trade_no,out_trade_no如果同时存在优先取trade_no | 20150320010101001             |
| trade_no      | String   | 特殊可选 | 64       | 支付宝交易号，和商户订单号不能同时为空                       | 2014112611001004680 073956707 |
| org_pid       | String   | 可选     | 16       | 银行间联模式下有用，其它场景请不要使用； 双联通过该参数指定需要查询的交易所属收单机构的pid; | 2088101117952222              |
| query_options | String[] | 可选     | 1024     | 查询选项，商户传入该参数可定制本接口同步响应额外返回的信息字段，数组格式。支持枚举如下：trade_settle_info：返回的交易结算信息，包含分账、补差等信息。 fund_bill_list：交易支付使用的资金渠道。 | trade_settle_info             |

##### 响应参数



| 参数                     | 类型              | 是否必填 | 最大长度 | 描述                                                         | 示例值                                               |
| ------------------------ | ----------------- | -------- | -------- | ------------------------------------------------------------ | ---------------------------------------------------- |
| trade_no                 | String            | 必填     | 64       | 支付宝交易号                                                 | 2013112011001004330000121536                         |
| out_trade_no             | String            | 必填     | 64       | 商家订单号                                                   | 6823789339978248                                     |
| buyer_logon_id           | String            | 必填     | 100      | 买家支付宝账号                                               | 159****5620                                          |
| trade_status             | String            | 必填     | 32       | 交易状态：WAIT_BUYER_PAY（交易创建，等待买家付款）、TRADE_CLOSED（未付款交易超时关闭，或支付完成后全额退款）、TRADE_SUCCESS（交易支付成功）、TRADE_FINISHED（交易结束，不可退款） | TRADE_CLOSED                                         |
| total_amount             | Price             | 必填     | 11       | 交易的订单金额，单位为元，两位小数。该参数的值为支付时传入的total_amount | 88.88                                                |
| trans_currency           | String            | 选填     | 8        | 标价币种，该参数的值为支付时传入的trans_currency，支持英镑：GBP、港币：HKD、美元：USD、新加坡元：SGD、日元：JPY、加拿大元：CAD、澳元：AUD、欧元：EUR、新西兰元：NZD、韩元：KRW、泰铢：THB、瑞士法郎：CHF、瑞典克朗：SEK、丹麦克朗：DKK、挪威克朗：NOK、马来西亚林吉特：MYR、印尼卢比：IDR、菲律宾比索：PHP、毛里求斯卢比：MUR、以色列新谢克尔：ILS、斯里兰卡卢比：LKR、俄罗斯卢布：RUB、阿联酋迪拉姆：AED、捷克克朗：CZK、南非兰特：ZAR、人民币：CNY、新台币：TWD。当trans_currency 和 settle_currency 不一致时，trans_currency支持人民币：CNY、新台币：TWD | TWD                                                  |
| settle_currency          | String            | 选填     | 8        | 订单结算币种，对应支付接口传入的settle_currency，支持英镑：GBP、港币：HKD、美元：USD、新加坡元：SGD、日元：JPY、加拿大元：CAD、澳元：AUD、欧元：EUR、新西兰元：NZD、韩元：KRW、泰铢：THB、瑞士法郎：CHF、瑞典克朗：SEK、丹麦克朗：DKK、挪威克朗：NOK、马来西亚林吉特：MYR、印尼卢比：IDR、菲律宾比索：PHP、毛里求斯卢比：MUR、以色列新谢克尔：ILS、斯里兰卡卢比：LKR、俄罗斯卢布：RUB、阿联酋迪拉姆：AED、捷克克朗：CZK、南非兰特：ZAR | USD                                                  |
| settle_amount            | Price             | 选填     | 11       | 结算币种订单金额                                             | 2.96                                                 |
| pay_currency             | Price             | 选填     | 8        | 订单支付币种                                                 | CNY                                                  |
| pay_amount               | String            | 选填     | 11       | 支付币种订单金额                                             | 8.88                                                 |
| settle_trans_rate        | String            | 选填     | 11       | 结算币种兑换标价币种汇率                                     | 30.025                                               |
| trans_pay_rate           | String            | 选填     | 11       | 标价币种兑换支付币种汇率                                     | 0.264                                                |
| buyer_pay_amount         | Price             | 选填     | 11       | 买家实付金额，单位为元，两位小数。该金额代表该笔交易买家实际支付的金额，不包含商户折扣等金额 | 8.88                                                 |
| point_amount             | Price             | 选填     | 11       | 积分支付的金额，单位为元，两位小数。该金额代表该笔交易中用户使用积分支付的金额，比如集分宝或者支付宝实时优惠等 | 10                                                   |
| invoice_amount           | Price             | 选填     | 11       | 交易中用户支付的可开具发票的金额，单位为元，两位小数。该金额代表该笔交易中可以给用户开具发票的金额 | 12.11                                                |
| send_pay_date            | Date              | 选填     | 32       | 本次交易打款给卖家的时间                                     | 2014-11-27 15:45:57                                  |
| receipt_amount           | String            | 选填     | 11       | 实收金额，单位为元，两位小数。该金额为本笔交易，商户账户能够实际收到的金额 | 15.25                                                |
| store_id                 | String            | 选填     | 32       | 商户门店编号                                                 | NJ_S_001                                             |
| terminal_id              | String            | 选填     | 32       | 商户机具终端编号                                             | NJ_T_001                                             |
| fund_bill_list           | TradeFundBill[]   | 必填     |          | 交易支付使用的资金渠道。 只有在签约中指定需要返回资金明细，或者入参的query_options中指定时才返回该字段信息。 |                                                      |
| store_name               | String            | 选填     | 512      | 请求交易支付中的商户店铺的名称                               | 证大五道口店                                         |
| buyer_user_id            | String            | 必填     | 16       | 买家在支付宝的用户id                                         | 2088101117955611                                     |
| industry_sepc_detail_gov | String            | 选填     | 4096     | 行业特殊信息-统筹相关                                        | {"registration_order_pay":{"brlx":"1","cblx":"1"}}   |
| industry_sepc_detail_acc | String            | 选填     | 4096     | 行业特殊信息-个账相关                                        | {"registration_order_pay":{"brlx":"1","cblx":"1"}}   |
| charge_amount            | String            | 选填     | 11       | 该笔交易针对收款方的收费金额； 只在银行间联交易场景下返回该信息； | 8.88                                                 |
| charge_flags             | String            | 选填     | 64       | 费率活动标识。 当交易享受特殊行业或活动费率时，返回该场景的标识。具体场景如下： trade_special_00：订单优惠费率； industry_special_on_00：线上行业特殊费率0； industry_special_on_01：线上行业特殊费率1； industry_special_00：线下行业特殊费率0； industry_special_01：线下行业特殊费率1； bluesea_1：蓝海活动优惠费率标签； 注：只在机构间联模式下返回，其它场景下不返回该字段； | bluesea_1                                            |
| settlement_id            | String            | 选填     | 64       | 支付清算编号，用于清算对账使用； 只在银行间联交易场景下返回该信息； | 2018101610032004620239146945                         |
| trade_settle_info        | TradeSettleInfo   | 选填     |          | 返回的交易结算信息，包含分账、补差等信息。 只有在query_options中指定时才返回该字段信息。 |                                                      |
| auth_trade_pay_mode      | String            | 选填     | 64       | 预授权支付模式，该参数仅在信用预授权支付场景下返回。信用预授权支付：CREDIT_PREAUTH_PAY | CREDIT_PREAUTH_PAY                                   |
| buyer_user_type          | String            | 选填     | 18       | 买家用户类型。CORPORATE:企业用户；PRIVATE:个人用户。         | PRIVATE                                              |
| mdiscount_amount         | String            | 选填     | 11       | 商家优惠金额                                                 | 88.88                                                |
| discount_amount          | String            | 选填     | 11       | 平台优惠金额                                                 | 88.88                                                |
| subject                  | String            | 选填     | 256      | 订单标题； 只在银行间联交易场景下返回该信息；                | Iphone6 16G                                          |
| body                     | String            | 选填     | 1000     | 订单描述； 只在银行间联交易场景下返回该信息；                | Iphone6 16G                                          |
| alipay_sub_merchant_id   | String            | 选填     | 32       | 间连商户在支付宝端的商户编号； 只在银行间联交易场景下返回该信息； | 2088301372182171                                     |
| ext_infos                | String            | 选填     | 1024     | 交易额外信息，特殊场景下与支付宝约定返回。 json格式。        | {"action":"cancel"}                                  |
| passback_params          | String            | 选填     | 512      | 公用回传参数。 返回支付时传入的passback_params参数信息       | merchantBizType%3d3C%26merchantBizNo%3d2016010101111 |
| hb_fq_pay_info           | HbFqPayInfo       | 选填     |          | 若用户使用花呗分期支付，且商家开通返回此通知参数，则会返回花呗分期信息。json格式其它说明详见花呗分期信息说明。 注意：商家需与支付宝约定后才返回本参数。 |                                                      |
| credit_pay_mode          | String            | 必填     | 64       | 信用支付模式。表示订单是采用信用支付方式（支付时买家没有出资，需要后续履约）。"creditAdvanceV2"表示芝麻先用后付模式，用户后续需要履约扣款。 此字段只有信用支付场景才有值，商户需要根据字段值单独处理。此字段以后可能扩展其他值，建议商户使用白名单方式识别，对于未识别的值做失败处理，并联系支付宝技术支持人员。 | creditAdvanceV2                                      |
| credit_biz_order_id      | String            | 必填     | 64       | 信用业务单号。信用支付场景才有值，先用后付产品里是芝麻订单号。 | ZMCB99202103310000450000041833                       |
| enterprise_pay_info      | EnterprisePayInfo | 必填     |          | 因公付支付信息                                               |                                                      |

##### 栗子：

```json
{
    "alipay_trade_query_response": {
        "code": "10000",
        "msg": "Success",
        "trade_no": "2013112011001004330000121536",
        "out_trade_no": "6823789339978248",
        "buyer_logon_id": "159****5620",
        "trade_status": "TRADE_CLOSED",
        "total_amount": 88.88,
        "trans_currency": "TWD",
        "settle_currency": "USD",
        "settle_amount": 2.96,
        "pay_currency": 1,
        "pay_amount": "8.88",
        "settle_trans_rate": "30.025",
        "trans_pay_rate": "0.264",
        "buyer_pay_amount": 8.88,
        "point_amount": 10,
        "invoice_amount": 12.11,
        "send_pay_date": "2014-11-27 15:45:57",
        "receipt_amount": "15.25",
        "store_id": "NJ_S_001",
        "terminal_id": "NJ_T_001",
        "fund_bill_list": [
            {
                "fund_channel": "ALIPAYACCOUNT",
                "amount": 10,
                "real_amount": 11.21
            }
        ],
        "store_name": "证大五道口店",
        "buyer_user_id": "2088101117955611",
        "industry_sepc_detail_gov": "{\"registration_order_pay\":{\"brlx\":\"1\",\"cblx\":\"1\"}}",
        "industry_sepc_detail_acc": "{\"registration_order_pay\":{\"brlx\":\"1\",\"cblx\":\"1\"}}",
        "charge_amount": "8.88",
        "charge_flags": "bluesea_1",
        "settlement_id": "2018101610032004620239146945",
        "trade_settle_info": {
            "trade_settle_detail_list": [
                {
                    "operation_type": "replenish",
                    "operation_serial_no": "2321232323232",
                    "operation_dt": "2019-05-16 09:59:17",
                    "trans_out": "208811****111111",
                    "trans_in": "208811****111111",
                    "amount": 10,
                    "ori_trans_out": "2088111111111111",
                    "ori_trans_in": "2088111111111111"
                }
            ]
        },
        "auth_trade_pay_mode": "CREDIT_PREAUTH_PAY",
        "buyer_user_type": "PRIVATE",
        "mdiscount_amount": "88.88",
        "discount_amount": "88.88",
        "subject": "Iphone6 16G",
        "body": "Iphone6 16G",
        "alipay_sub_merchant_id": "2088301372182171",
        "ext_infos": "{\"action\":\"cancel\"}",
        "passback_params": "merchantBizType%3d3C%26merchantBizNo%3d2016010101111",
        "hb_fq_pay_info": {
            "user_install_num": "3"
        },
        "credit_pay_mode": "creditAdvanceV2",
        "credit_biz_order_id": "ZMCB99202103310000450000041833",
        "enterprise_pay_info": {
            "invoice_amount": 80
        }
    },
    "sign": "ERITJKEIJKJHKKKKKKKHJEREEEEEEEEEEE"
}
```

#### 统一收单交易退款接口

```java
@Override
public String refund(PayRefundOrderDto dto) throws AlipayApiException {
    AlipayClient alipayClient = new DefaultAlipayClient(properties.getGatewayUrl(), properties.getAppId(), properties.getApplicationAlipayPrivateKey(), properties.getFormat(), properties.getCharset(), properties.getAlipayPublicKey(), properties.getSignType());
    AlipayTradeRefundRequest request = new AlipayTradeRefundRequest();
    JSONObject bizContent = new JSONObject();
    bizContent.put("out_trade_no", dto.getOutTradeNo());
    bizContent.put("refund_amount", dto.getTotalAmount());
    bizContent.put("trade_no", dto.getTradeNo());
    request.setBizContent(bizContent.toString());
    AlipayTradeRefundResponse response = alipayClient.execute(request, "GET");
    if (response.isSuccess()) {
        log.info("调用成功~");
    } else {
        log.info("调用失败~");
    }
    String result = response.getBody();
    log.info(result);
    log.info("以下写自己的订单代码 ~");
    return result;
}
```

##### 请求参数

| 参数                      | 类型                           | 是否必填 | 最大长度 | 描述                                                         | 示例值                       |
| ------------------------- | ------------------------------ | -------- | -------- | ------------------------------------------------------------ | ---------------------------- |
| out_trade_no              | String                         | 特殊可选 | 64       | 商户订单号。 订单支付时传入的商户订单号，商家自定义且保证商家系统中唯一。与支付宝交易号 trade_no 不能同时为空。 | 20150320010101001            |
| trade_no                  | String                         | 特殊可选 | 64       | 支付宝交易号。 和商户订单号 out_trade_no 不能同时为空。      | 2014112611001004680073956707 |
| refund_amount             | Price                          | 必选     | 11       | 退款金额。 需要退款的金额，该金额不能大于订单金额，单位为元，支持两位小数。 注：如果正向交易使用了营销，该退款金额包含营销金额，支付宝会按业务规则分配营销和买家自有资金分别退多少，默认优先退买家的自有资金。如交易总金额100元，用户支付时使用了80元自有资金和20元无资金流的营销券，商家实际收款80元。如果首次请求退款60元，则60元全部从商家收款资金扣除退回给用户自有资产；如果再请求退款40元，则从商家收款资金扣除20元退回用户资产以及把20元的营销券退回给用户（券是否可再使用取决于券的规则配置）。 | 200.12                       |
| refund_reason             | String                         | 可选     | 256      | 退款原因说明。 商家自定义，将在对账单的退款明细中作为备注返回，同时会在商户和用户的pc退款账单详情中展示 | 正常退款                     |
| out_request_no            | String                         | 可选     | 64       | 退款请求号。 标识一次退款请求，需要保证在交易号下唯一，如需部分退款，则此参数必传。 注：针对同一次退款请求，如果调用接口失败或异常了，重试时需要保证退款请求号不能变更，防止该笔交易重复退款。支付宝会保证同样的退款请求号多次请求只会退一次。 | HZ01RF001                    |
| refund_royalty_parameters | OpenApiRoyaltyDetailInfoPojo[] | 可选     |          | 退分账明细信息。 注： 1.当面付且非直付通模式无需传入退分账明细，系统自动按退款金额与订单金额的比率，从收款方和分账收入方退款，不支持指定退款金额与退款方。 2.直付通模式，电脑网站支付，手机 APP 支付，手机网站支付产品，须在退款请求中明确是否退分账，从哪个分账收入方退，退多少分账金额；如不明确，默认从收款方退款，收款方余额不足退款失败。不支持系统按比率退款。 |                              |
| query_options             | String[]                       | 可选     | 1024     | 查询选项。 商户通过上送该参数来定制同步需要额外返回的信息字段，数组格式。支持：refund_detail_item_list：退款使用的资金渠道。 | refund_detail_item_list      |

##### 响应参数

| 参数                    | 类型            | 是否必填 | 最大长度 | 描述                                                         | 示例值           |
| ----------------------- | --------------- | -------- | -------- | ------------------------------------------------------------ | ---------------- |
| trade_no                | String          | 必填     | 64       | 2013112011001004330000121536                                 | 支付宝交易号     |
| out_trade_no            | String          | 必填     | 64       | 商户订单号                                                   | 6823789339978248 |
| buyer_logon_id          | String          | 必填     | 100      | 用户的登录id                                                 | 159****5620      |
| fund_change             | String          | 必填     | 1        | 本次退款是否发生了资金变化                                   | Y                |
| refund_fee              | Price           | 必填     | 11       | 退款总金额。 指该笔交易累计已经退款成功的金额。              | 88.88            |
| refund_detail_item_list | TradeFundBill[] | 选填     |          | 退款使用的资金渠道。 只有在签约中指定需要返回资金明细，或者入参的query_options中指定时才返回该字段信息。 |                  |
| store_name              | String          | 选填     | 512      | 交易在支付时候的门店名称                                     | 望湘园联洋店     |
| buyer_user_id           | String          | 必填     | 28       | 买家在支付宝的用户id                                         | 2088101117955611 |
| send_back_fee           | String          | 选填     | 11       | 本次商户实际退回金额。 说明：如需获取该值，需在入参query_options中传入 refund_detail_item_list。 | 1.8              |

##### 栗子：

```json
{
    "alipay_trade_refund_response": {
        "code": "10000",
        "msg": "Success",
        "trade_no": "支付宝交易号",
        "out_trade_no": "6823789339978248",
        "buyer_logon_id": "159****5620",
        "fund_change": "Y",
        "refund_fee": 88.88,
        "refund_detail_item_list": [
            {
                "fund_channel": "ALIPAYACCOUNT",
                "amount": 10,
                "real_amount": 11.21,
                "fund_type": "DEBIT_CARD"
            }
        ],
        "store_name": "望湘园联洋店",
        "buyer_user_id": "2088101117955611",
        "send_back_fee": "1.8"
    },
    "sign": "ERITJKEIJKJHKKKKKKKHJEREEEEEEEEEEE"
}
```

#### 统一收单交易退款查询

```java
@Override
public String queryRefundOrder(String outTradeNo) throws AlipayApiException {
    AlipayClient alipayClient = new DefaultAlipayClient(properties.getGatewayUrl(), properties.getAppId(), properties.getApplicationAlipayPrivateKey(), properties.getFormat(), properties.getCharset(), properties.getAlipayPublicKey(), properties.getSignType());
    AlipayTradeFastpayRefundQueryRequest request = new AlipayTradeFastpayRefundQueryRequest();
    JSONObject bizContent = new JSONObject();
    bizContent.put("out_trade_no", outTradeNo);
    bizContent.put("out_request_no", outTradeNo);
    request.setBizContent(bizContent.toString());
    AlipayTradeFastpayRefundQueryResponse response = alipayClient.execute(request);
    if (response.isSuccess()) {
        log.info("调用成功~");
    } else {
        log.info("调用失败~");
    }
    String result = response.getBody();
    log.info("查询一下~");
    log.info(result);
    return result;
}
```

##### 请求参数

| 参数           | 类型     | 是否必填 | 最大长度 | 描述                                                         | 示例值                       |
| -------------- | -------- | -------- | -------- | ------------------------------------------------------------ | ---------------------------- |
| trade_no       | String   | 特殊可选 | 64       | 支付宝交易号。 和商户订单号不能同时为空                      | 2021081722001419121412730660 |
| out_trade_no   | String   | 特殊可选 | 64       | 商户订单号。 订单支付时传入的商户订单号,和支付宝交易号不能同时为空。 trade_no,out_trade_no如果同时存在优先取trade_no | 2014112611001004680073956707 |
| out_request_no | String   | 必选     | 64       | 退款请求号。 请求退款接口时，传入的退款请求号，如果在退款请求时未传入，则该值为创建交易时的商户订单号。 | HZ01RF001                    |
| query_options  | String[] | 可选     | 1024     | 查询选项，商户通过上送该参数来定制同步需要额外返回的信息字段，数组格式。枚举支持： refund_detail_item_list：本次退款使用的资金渠道； gmt_refund_pay：退款执行成功的时间； deposit_back_info：银行卡冲退信息； | refund_detail_item_list      |

##### 响应参数

| 参数                    | 类型                  | 是否必填 | 最大长度 | 描述                                                         | 示例值                       |
| ----------------------- | --------------------- | -------- | -------- | ------------------------------------------------------------ | ---------------------------- |
| trade_no                | String                | 选填     | 64       | 支付宝交易号                                                 | 2014112611001004680073956707 |
| out_trade_no            | String                | 选填     | 64       | 创建交易传入的商户订单号                                     | 20150320010101001            |
| out_request_no          | String                | 选填     | 64       | 本笔退款对应的退款请求号                                     | 20150320010101001            |
| total_amount            | Price                 | 选填     | 11       | 该笔退款所对应的交易的订单金额                               | 100.20                       |
| refund_amount           | Price                 | 选填     | 11       | 本次退款请求，对应的退款金额                                 | 12.33                        |
| refund_status           | String                | 选填     | 32       | 退款状态。枚举值： REFUND_SUCCESS 退款处理成功； 未返回该字段表示退款请求未收到或者退款失败； 注：如果退款查询发起时间早于退款时间，或者间隔退款发起时间太短，可能出现退款查询时还没处理成功，后面又处理成功的情况，建议商户在退款发起后间隔10秒以上再发起退款查询请求。 | REFUND_SUCCESS               |
| refund_royaltys         | RefundRoyaltyResult[] | 选填     |          | 退分账明细信息                                               |                              |
| gmt_refund_pay          | Date                  | 选填     | 32       | 退款时间。默认不返回该信息，需要在入参的query_options中指定"gmt_refund_pay"值时才返回该字段信息。 | 2014-11-27 15:45:57          |
| refund_detail_item_list | TradeFundBill[]       | 选填     |          | 本次退款使用的资金渠道； 默认不返回该信息，需要在入参的query_options中指定"refund_detail_item_list"值时才返回该字段信息。 |                              |
| send_back_fee           | String                | 选填     | 11       | 本次商户实际退回金额； 默认不返回该信息，需要在入参的query_options中指定"refund_detail_item_list"值时才返回该字段信息。 | 88                           |
| deposit_back_info       | DepositBackInfo       | 选填     |          | 银行卡冲退信息； 默认不返回该信息，需要在入参的query_options中指定"deposit_back_info"值时才返回该字段信息。 |                              |

##### 栗子：

```json
{
    "alipay_trade_fastpay_refund_query_response": {
        "code": "10000",
        "msg": "Success",
        "trade_no": "2014112611001004680073956707",
        "out_trade_no": "20150320010101001",
        "out_request_no": "20150320010101001",
        "total_amount": 100.2,
        "refund_amount": 12.33,
        "refund_status": "REFUND_SUCCESS",
        "refund_royaltys": [
            {
                "refund_amount": 10,
                "royalty_type": "transfer",
                "result_code": "SUCCESS",
                "trans_out": "2088102210397302",
                "trans_out_email": "alipay-test03@alipay.com",
                "trans_in": "2088102210397302",
                "trans_in_email": "zen_gwen@hotmail.com"
            }
        ],
        "gmt_refund_pay": "2014-11-27 15:45:57",
        "refund_detail_item_list": [
            {
                "fund_channel": "ALIPAYACCOUNT",
                "amount": 10,
                "real_amount": 11.21,
                "fund_type": "DEBIT_CARD"
            }
        ],
        "send_back_fee": "88",
        "deposit_back_info": {
            "has_deposit_back": "true",
            "dback_status": "S",
            "dback_amount": 1.01,
            "bank_ack_time": "2020-06-02 14:03:48",
            "est_bank_receipt_time": "2020-06-02 14:03:48"
        }
    },
    "sign": "ERITJKEIJKJHKKKKKKKHJEREEEEEEEEEEE"
}
```

#### 统一收单交易关闭接口

```java
@Override
public String closeOrder(String outTradeNo) throws AlipayApiException {
    AlipayClient alipayClient = new DefaultAlipayClient(properties.getGatewayUrl(), properties.getAppId(), properties.getApplicationAlipayPrivateKey(), properties.getFormat(), properties.getCharset(), properties.getAlipayPublicKey(), properties.getSignType());
    AlipayTradeCloseRequest request = new AlipayTradeCloseRequest();
    JSONObject bizContent = new JSONObject();
    bizContent.put("out_trade_no", outTradeNo);
    request.setBizContent(bizContent.toString());
    AlipayTradeCloseResponse response = alipayClient.execute(request);
    if (response.isSuccess()) {
        log.info("调用成功~");
    } else {
        log.info("调用失败~");
    }
    String result = response.getBody();
    log.info("关闭订单~");
    log.info(result);
    return result;
}
```

##### 请求参数

| 参数         | 类型   | 是否必填 | 最大长度 | 描述                                                         | 示例值                       |
| ------------ | ------ | -------- | -------- | ------------------------------------------------------------ | ---------------------------- |
| trade_no     | String | 特殊可选 | 64       | 该交易在支付宝系统中的交易流水号。最短 16 位，最长 64 位。和out_trade_no不能同时为空，如果同时传了 out_trade_no和 trade_no，则以 trade_no为准。 | 2013112611001004680073956707 |
| out_trade_no | String | 特殊可选 | 64       | 订单支付时传入的商户订单号,和支付宝交易号不能同时为空。 trade_no,out_trade_no如果同时存在优先取trade_no | HZ0120131127001              |
| operator_id  | String | 可选     | 28       | 商家操作员编号 id，由商家自定义。                            | YX01                         |

##### 响应参数

| 参数         | 类型   | 是否必填 | 最大长度 | 描述                     | 示例值                       |
| ------------ | ------ | -------- | -------- | ------------------------ | ---------------------------- |
| trade_no     | String | 选填     | 64       | 支付宝交易号             | 2013112111001004500000675971 |
| out_trade_no | String | 选填     | 64       | 创建交易传入的商户订单号 | YX_001                       |

##### 栗子：

```json
{
    "alipay_trade_close_response": {
        "code": "10000",
        "msg": "Success",
        "trade_no": "2013112111001004500000675971",
        "out_trade_no": "YX_001"
    },
    "sign": "ERITJKEIJKJHKKKKKKKHJEREEEEEEEEEEE"
}
```

#### app支付接口2.0

```java
@Override
public String appPay(PayOrderDto dto) throws AlipayApiException {
    AlipayClient alipayClient = new DefaultAlipayClient(properties.getGatewayUrl(), properties.getAppId(), properties.getApplicationAlipayPrivateKey(), properties.getFormat(), properties.getCharset(), properties.getAlipayPublicKey(), properties.getSignType());
    AlipayTradeAppPayRequest request = new AlipayTradeAppPayRequest();
    request.setNotifyUrl(properties.getNotifyUrl());
    AlipayTradeAppPayModel model = new AlipayTradeAppPayModel();
    model.setOutTradeNo(dto.getOutTradeNo());
    model.setTotalAmount(dto.getTotalAmount());
    model.setSubject(dto.getSubject());
    model.setProductCode("QUICK_MSECURITY_PAY");
    request.setBizModel(model);
    AlipayTradeAppPayResponse response = alipayClient.sdkExecute(request);
    if (response.isSuccess()) {
        log.info("调用成功~");
    } else {
        log.info("调用失败~");
    }
    String result = response.getBody();
    log.info("app支付~");
    log.info(result);
    return result;
}
```

##### 请求参数

| 参数              | 类型          | 是否必填 | 最大长度 | 描述                                                         | 示例值                                               |
| ----------------- | ------------- | -------- | -------- | ------------------------------------------------------------ | ---------------------------------------------------- |
| out_trade_no      | String        | 必选     | 64       | 商户网站唯一订单号。 由商家自定义，64个字符以内，仅支持字母、数字、下划线且需保证在商户端不重复。 | 70501111111S001111119                                |
| total_amount      | String        | 必选     | 9        | 订单总金额，单位为元，精确到小数点后两位，取值范围[0.01,100000000]，金额不能为0 | 9.00                                                 |
| subject           | String        | 必选     | 256      | 订单标题。 注意：不可使用特殊字符，如 /，=，& 等。           | 大乐透                                               |
| product_code      | String        | 可选     | 64       | 销售产品码，商家和支付宝签约的产品码                         | QUICK_MSECURITY_PAY                                  |
| goods_detail      | GoodsDetail[] | 可选     |          | 订单包含的商品列表信息，json格式，其它说明详见商品明细说明   |                                                      |
| time_expire       | String        | 可选     | 32       | 绝对超时时间，格式为yyyy-MM-dd HH:mm:ss                      | 2016-12-31 10:05:00                                  |
| extend_params     | ExtendParams  | 可选     |          | 业务扩展参数                                                 |                                                      |
| promo_params      | String        | 可选     | 512      | 优惠参数（json 格式，仅与支付宝协商后可用）                  | {"storeIdType":"1"}                                  |
| passback_params   | String        | 可选     | 512      | 公用回传参数，如果请求时传递了该参数，则返回给商户时会回传该参数。支付宝只会在同步返回（包括跳转回商户网站）和异步通知时将该参数原样返回。本参数必须进行UrlEncode之后才可以发送给支付宝。 | merchantBizType%3d3C%26merchantBizNo%3d2016010101111 |
| merchant_order_no | String        | 可选     | 32       | 商户原始订单号，最大长度限制32位                             | 20161008001                                          |
| ext_user_info     | ExtUserInfo   | 可选     |          | 外部指定买家                                                 |                                                      |

##### 响应参数

| 参数              | 类型   | 是否必填 | 最大长度 | 描述                                                         | 示例值                       |
| ----------------- | ------ | -------- | -------- | ------------------------------------------------------------ | ---------------------------- |
| out_trade_no      | String | 必选     | 64       | 商户网站唯一订单号                                           | 70501111111S001111119        |
| trade_no          | String | 必选     | 64       | 该交易在支付宝系统中                                         | 2014112400001000340011111118 |
| total_amount      | String | 必选     | 9        | 该笔订单的资金总额，单位为人民币（元），取值范围为 0.01~100000000.00，精确到小数点后两位。 | 9.00                         |
| seller_id         | String | 必选     | 16       | 收款支付宝账号对应的支付宝唯一用户号。 以2088开头的纯16位数字 | 2088111111116894             |
| merchant_order_no | String | 必选     | 32       | 商户原始订单号，最大长度限制32位                             | 20161008001                  |

##### 栗子：

```xml
// 响应为表单格式，可嵌入页面，具体以返回的结果为准
<form name="submit_form" method="post" action="https://openapi.alipay.com/gateway.do?charset=UTF-8&method=alipay.trade.app.pay&sign=k0w1DePFqNMQWyGBwOaEsZEJuaIEQufjoPLtwYBYgiX%2FRSkBFY38VuhrNumXpoPY9KgLKtm4nwWz4DEQpGXOOLaqRZg4nDOGOyCmwHmVSV5qWKDgWMiW%2BLC2f9Buil%2BEUdE8CFnWhM8uWBZLGUiCrAJA14hTjVt4BiEyiPrtrMZu0o6%2FXsBu%2Fi6y4xPR%2BvJ3KWU8gQe82dIQbowLYVBuebUMc79Iavr7XlhQEFf%2F7WQcWgdmo2pnF4tu0CieUS7Jb0FfCwV%2F8UyrqFXzmCzCdI2P5FlMIMJ4zQp%2BTBYsoTVK6tg12stpJQGa2u3%2BzZy1r0KNzxcGLHL%2BwWRTx%2FCU%2Fg%3D%3D&notify_url=http%3A%2F%2F114.55.81.185%2Fopendevtools%2Fnotify%2Fdo%2Fbf70dcb4-13c9-4458-a547-3a5a1e8ead04&version=1.0&app_id=2014100900013222&sign_type=RSA&timestamp=2021-02-02+14%3A11%3A40&alipay_sdk=alipay-sdk-java-dynamicVersionNo&format=json">
<input type="submit" value="提交" style="display:none" >
</form>
<script>document.forms[0].submit();</script>
```

#### 手机网站支付接口2.0

```java
@Override
public Object wapPay(PayOrderDto dto) throws AlipayApiException {
    AlipayClient alipayClient = new DefaultAlipayClient(properties.getGatewayUrl(), properties.getAppId(), properties.getApplicationAlipayPrivateKey(), properties.getFormat(), properties.getCharset(), properties.getAlipayPublicKey(), properties.getSignType());
    AlipayTradeWapPayRequest request = new AlipayTradeWapPayRequest();
    request.setReturnUrl(properties.getReturnUrl());
    request.setNotifyUrl(properties.getNotifyUrl());
    AlipayTradeWapPayModel model = new AlipayTradeWapPayModel();
    model.setOutTradeNo(dto.getOutTradeNo());
    model.setTotalAmount(dto.getTotalAmount());
    model.setSubject(dto.getSubject());
    model.setProductCode("QUICK_WAP_WAY");
    request.setBizModel(model);
    AlipayTradeWapPayResponse response = alipayClient.pageExecute(request, "GET");
    if (response.isSuccess()) {
        log.info("调用成功~");
    } else {
        log.info("调用失败~");
    }
    String result = response.getBody();
    log.info("app支付~");
    log.info(result);
    return result;
}
```

##### 请求参数

| 参数              | 类型          | 是否必填 | 最大长度 | 描述                                                         | 示例值                                               |
| ----------------- | ------------- | -------- | -------- | ------------------------------------------------------------ | ---------------------------------------------------- |
| out_trade_no      | String        | 必选     | 64       | 商户网站唯一订单号                                           | 70501111111S001111119                                |
| total_amount      | Price         | 必选     | 9        | 订单总金额。 单位为元，精确到小数点后两位，取值范围：[0.01,100000000] 。 | 9.00                                                 |
| subject           | String        | 必选     | 256      | 订单标题。 注意：不可使用特殊字符，如 /，=，& 等。           | 大乐透                                               |
| product_code      | String        | 必选     | 64       | 销售产品码，商家和支付宝签约的产品码。手机网站支付为：QUICK_WAP_WAY | QUICK_WAP_WAY                                        |
| auth_token        | String        | 可选     | 40       | 针对用户授权接口，获取用户相关数据时，用于标识用户授权关系   | appopenBb64d181d0146481ab6a762c00714cC27             |
| quit_url          | String        | 必选     | 400      | 用户付款中途退出返回商户网站的地址                           | http://www.taobao.com/product/113714.html            |
| goods_detail      | GoodsDetail[] | 可选     |          | 订单包含的商品列表信息，json格式，其它说明详见商品明细说明   |                                                      |
| time_expire       | String        | 可选     | 32       | 绝对超时时间，格式为yyyy-MM-dd HH:mm:ss                      | 2016-12-31 10:05:00                                  |
| extend_params     | ExtendParams  | 可选     |          | 业务扩展参数                                                 |                                                      |
| business_params   | String        | 可选     | 512      | 商户传入业务信息，具体值要和支付宝约定，应用于安全，营销等参数直传场景，格式为json格式 | {"data":"123"}                                       |
| promo_params      | String        | 可选     | 512      | 优惠参数 （json 格式，仅与支付宝协商后可用）                 | {"storeIdType":"1"}                                  |
| passback_params   | String        | 可选     | 512      | 公用回传参数，如果请求时传递了该参数，则返回给商户时会回传该参数。支付宝只会在同步返回（包括跳转回商户网站）和异步通知时将该参数原样返回。本参数必须进行UrlEncode之后才可以发送给支付宝。 | merchantBizType%3d3C%26merchantBizNo%3d2016010101111 |
| merchant_order_no | String        | 可选     | 32       | 商户原始订单号，最大长度限制32位                             | 20161008001                                          |

##### 响应参数

| 参数              | 类型   | 是否必填 | 最大长度 | 描述                                                         | 示例值                       |
| ----------------- | ------ | -------- | -------- | ------------------------------------------------------------ | ---------------------------- |
| out_trade_no      | String | 必选     | 64       | 商户网站唯一订单号                                           | 70501111111S001111119        |
| trade_no          | String | 必选     | 64       | 该交易在支付宝系统中的交易流水号。最长64位。                 | 2014112400001000340011111118 |
| total_amount      | Price  | 必选     | 9        | 该笔订单的资金总额，单位为人民币（元），取值范围为 0.01~100000000.00，精确到小数点后两位。 | 9.00                         |
| seller_id         | String | 必选     | 16       | 收款支付宝账号对应的支付宝唯一用户号。 以2088开头的纯16位数字 | 2088111111116894             |
| merchant_order_no | String | 必选     | 32       | 商户原始订单号，最大长度限制32位                             | 20161008001                  |

##### 栗子：

```xml
// 响应为表单格式，可嵌入页面，具体以返回的结果为准
<form name="submit_form" method="post" action="https://openapi.alipay.com/gateway.do?charset=UTF-8&method=alipay.trade.wap.pay&sign=k0w1DePFqNMQWyGBwOaEsZEJuaIEQufjoPLtwYBYgiX%2FRSkBFY38VuhrNumXpoPY9KgLKtm4nwWz4DEQpGXOOLaqRZg4nDOGOyCmwHmVSV5qWKDgWMiW%2BLC2f9Buil%2BEUdE8CFnWhM8uWBZLGUiCrAJA14hTjVt4BiEyiPrtrMZu0o6%2FXsBu%2Fi6y4xPR%2BvJ3KWU8gQe82dIQbowLYVBuebUMc79Iavr7XlhQEFf%2F7WQcWgdmo2pnF4tu0CieUS7Jb0FfCwV%2F8UyrqFXzmCzCdI2P5FlMIMJ4zQp%2BTBYsoTVK6tg12stpJQGa2u3%2BzZy1r0KNzxcGLHL%2BwWRTx%2FCU%2Fg%3D%3D&notify_url=http%3A%2F%2F114.55.81.185%2Fopendevtools%2Fnotify%2Fdo%2Fbf70dcb4-13c9-4458-a547-3a5a1e8ead04&version=1.0&app_id=2014100900013222&sign_type=RSA&timestamp=2021-02-02+14%3A11%3A40&alipay_sdk=alipay-sdk-java-dynamicVersionNo&format=json">
<input type="submit" value="提交" style="display:none" >
</form>
<script>document.forms[0].submit();</script>
```

